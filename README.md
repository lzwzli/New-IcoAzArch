# New-IcoAzArch
## Introduction  

Creates an ICONICS architecture that is made up of the ICONICS recommended functionality layers. Functionality layers are:
- **IO**  
    *This layer is responsible for all data input output from external sources. Commonly segregated by protocol type or geography.*

- **Asset**  
    *This layer is responsible for organizing and normalizing the data from IO servers into logical structures using AssetWorX. FDD configuration is also done at this layer.*  

- **Alarm**  
    *This layer is responsible for alarm processing in high volume solutions.*

- **Historian**  
    *This layer is responsible for logging all history data for the solution.*

- **Integration**  
    *This layer is responsible for integration to external sources and capabilities.*

- **Aggregator**  
    *This layer is responsible for aggregating the distributed AssetWorX hierarchies into a single accessible structure.  
    This layer can also be optionally used to host the front end for low to medium sized projects with low user count.*

- **Front End**  
    *This layer is responsible for providing front end access to clients.*

Each layer described above are optional depending on the solution size, need for scalability and concurrent client counts.  

## Dependencies  
Requires **New-IcoAzVM** cmdlet version 5.7 (included in package) or newer.  

## Pre-requisites  
Before running this Cmdlet, ensure you have the following information:  
- **Subscription name** where resources should be created in.  
- **Resource Group name** where resources should be created in.  
    - If the given Resource Group name doesn't exist in the subscription, a new one will be created.  
- **Azure region** where resources should be created in.  
    - If an existing Resource Group is re-used, then the Azure region of the Resource Group will be applied.  
    - List of Azure regions can be found here: https://azure.microsoft.com/en-us/global-infrastructure/geographies/
    - Enter Azure regions in lowercase and without spaces
- **Number of VMs** of each functional layer to provision.  
- **Azure VM Size name** of each functional layer to provision
- **SSD option**
    - If SSD option is chosen, VMs will use Premium SSD for its OS disk. Otherwise, Standard HDD is used.
- **Prefix name** of the virtual machines.  
    - The machine name of the VM will be generated by appending the VM's functional layer name and an index number to the Prefix name.  
    - The index number appended will depend on the existence of VMs with the same Prefix name.  
    - If there are VMs of the same functional layer in the Resource Group with the same Prefix name, then the index will be the count of VMs with the same Prefix name + 1. Otherwise, it will start at 1.  
- **ICONICS Suite version**
- **User Name** of the initial administrator account.  
- **Password** that meets the following requirements:  
    - At least 12 characters long.
    - Have one or more lower case alphabets.  
    - Have one or more upper case alphabets.  
    - Have one or more numbers.  
    - Have one or more symbol characters. 
- If a new resource group is being created, you will be asked if you want to allow:  
    - **HTTP** inbound using TCP port 80  
    - **ICONICS FrameWorX** inbound using TCP port 8778  
    
    *Note that this only opens the ports at the Azure NSG level. The respective ports still need to be allowed in the VM's Windows Firewall.*  

## Using the Cmdlet  
This Cmdlet can be launched from:  
- PowerShell 7 with the Azure module
- Azure portal cloud shell  

Once in the directory where this Cmdlet is saved, invoke it by typing: **./New-IcoAzArch.ps1**  

Optionally, parameters can be passed in with the following parameter names:
- **SubscriptionName**  
- **ResourceGroupName**  
- **Location** *(eastus,westeurope,...)*  
- **IOVMCount** *(1,2,3,...)*  
- **IOVMSize** *(B2s, B2ms, D3_v2,...)*  
- **AssetVMCount** *(1,2,3,...)*  
- **AssetVMSize** *(B2s, B2ms, D3_v2,...)*  
- **AlarmVMCount** *(1,2,3,...)*  
- **AlarmVMSize** *(B2s, B2ms, D3_v2,...)*  
- **HistVMCount** *(1,2,3,...)*  
- **HistVMSize** *(B2s, B2ms, D3_v2,...)*  
- **IntVMCount** *(1,2,3,...)*  
- **IntVMSize** *(B2s, B2ms, D3_v2,...)*  
- **AggVMCount** *(1,2,3,...)*  
- **AggVMSize** *(B2s, B2ms, D3_v2,...)*  
- **FEVMCount** *(1,2,3,...)*  
- **FEVMSize** *(B2s, B2ms, D3_v2,...)*  
- **UseSSD** *(Y/N)*  
- **VMPrefix**  
- **ICONICSversion** *(10.96.1, 10.96.2)*  
- **Username**  
- **Password** *(min. 12 characters, one upper, one lower, one number, one symbol)*  
- **AllowHTTP** *(Y/N)*  
- **AllowFWX** *(Y/N)*  

For any parameter that is not defined when triggering the Cmdlet, prompts will show up to guide you through the rest.  

## Known issues  
1. If the list of existing VMs with the same Prefix name have out of order index numbers, this script will fail.  
        
    i.e.: if your chosen Prefix name is "TestVM" and there is "TestVM-1" and "TestVM-3" in your resource group, this script will count the 2 VMs and use 3 as the next index number, resulting in an attempt to create a VM named "TestVM-3", and failing.  

## Examples  
### Create a 3 layer architecture suitable for small to medium solutions, composed of Asset, Historian, and Aggregator layers.  

    ./New-IcoAzArch.ps1 -SubscriptionName MySubscription -ResourceGroupName MyResourceGrp -Location eastus -IOVMCount 0 -AssetVMCount 1 -AssetVMSize B4ms -AlarmVMCount 0 -HistVMCount 1 -HistVMSize B4ms -IntVMCount 0 -AggVMCount 1 -AggVMSize B4ms -FEVMCount 0 -UseSSD N -VMPrefix IcoVM -ICONICSversion 10.96.2 -Username iconicsadmin -AllowHTTP Y -AllowFWX Y  

The example above would prompt for the *iconicsadmin* password and then create the following:  
1. Set the subscription to *MySubscription*.  
1. Create *MyResourceGrp* in the *eastus* region if it doesn't exist, otherwise use the existing resource group.  
1. If a new resource group is created, also create the network components like subnet, VNet and NSG. The NSG will have *HTTP (TCP port 80)* and *FrameWorX (TCP port 8778)* allowed for inbound.  
1. Use ICONICS Suite *10.96.2* for all VMs.  
1. Create *1* Asset VM of *B4ms* size using *Standard HDD* OS disk.  
1. Create *1* Historian VM of *B4ms* size using *Standard HDD* OS disk.  
1. Create *1* Aggregator VM of *B4ms* size using *Standard HDD* OS disk.  

### Create a 5 layer architecture suitable for large complex solutions, composed of IO, Asset, Historian, Aggregator, and Front End layers.

    ./New-IcoAzArch.ps1 -SubscriptionName MySubscription -ResourceGroupName MyResourceGrp -Location eastus -IOVMCount 1 -IOVMSize B2ms -AssetVMCount 1 -AssetVMSize B4ms -AlarmVMCount 0 -HistVMCount 1 -HistVMSize B4ms -IntVMCount 0 -AggVMCount 1 -AggVMSize B4ms -FEVMCount 1 -FEVMSize B4ms -UseSSD N -VMPrefix IcoVM -ICONICSversion 10.96.2 -Username iconicsadmin -AllowHTTP Y -AllowFWX Y  

The example above would prompt for the *iconicsadmin* password and then create the following:  
1. Set the subscription to *MySubscription*.  
1. Create *MyResourceGrp* in the *eastus* region if it doesn't exist, otherwise use the existing resource group.  
1. If a new resource group is created, also create the network components like subnet, VNet and NSG. The NSG will have *HTTP (TCP port 80)* and *FrameWorX (TCP port 8778)* allowed for inbound.  
1. Use ICONICS Suite *10.96.2* for all VMs.  
1. Create *1* IO VM of *B2ms* size using *Standard HDD* OS disk.  
1. Create *1* Asset VM of *B4ms* size using *Standard HDD* OS disk.  
1. Create *1* Historian VM of *B4ms* size using *Standard HDD* OS disk.  
1. Create *1* Aggregator VM of *B4ms* size using *Standard HDD* OS disk.  
1. Create *1* Front End VM of *B4ms* size using *Standard HDD* OS disk.  